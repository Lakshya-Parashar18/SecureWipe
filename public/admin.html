<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SecureWipe Admin</title>
    <link rel="icon" type="image/png" href="/logo.png" />
    <style>
      :root { color-scheme: dark; }
      body { margin: 0; font-family: system-ui, Inter, Segoe UI, Roboto, sans-serif; background: #0b1220; color: #e5e7eb; }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
      h1 { margin: 0 0 10px; font-size: 1.8rem; background: linear-gradient(135deg, #60a5fa, #22d3ee, #a78bfa); -webkit-background-clip: text; background-clip: text; color: transparent; }
      .card { background: linear-gradient(180deg, rgba(15,23,42,0.65), rgba(15,23,42,0.4)); border: 1px solid rgba(148,163,184,0.16); border-radius: 12px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.04); }
      .grid { display: grid; gap: 16px; }
      label { display: block; font-weight: 700; margin-bottom: 6px; color: #cbd5e1; }
      input { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(148,163,184,0.2); background: rgba(2,6,23,0.6); color: #e5e7eb; }
      button { padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(59,130,246,0.6); background: linear-gradient(135deg, #2563eb, #1e40af); color: #fff; font-weight: 700; cursor: pointer; }
      .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
      .topbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
      .muted { color: #94a3b8; }
      table { width: 100%; border-collapse: collapse; }
      th, td { text-align: left; border-bottom: 1px solid rgba(148,163,184,0.16); padding: 10px 8px; vertical-align: top; }
      th { color: #e5e7eb; }
      .actions { display: flex; gap: 8px; }
      .danger { border-color: rgba(239,68,68,0.6); background: linear-gradient(135deg, #ef4444, #b91c1c); }
      .login { max-width: 420px; margin: 40px auto; }
      .hidden { display: none !important; }
      pre { margin: 0; white-space: pre-wrap; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="topbar">
        <h1>SecureWipe Admin</h1>
        <div>
          <a href="/" class="muted">← Back</a>
        </div>
      </div>

      <div id="login" class="card login">
        <div class="row">
          <div>
            <label for="username">Username</label>
            <input id="username" autocomplete="username" />
          </div>
          <div>
            <label for="password">Password</label>
            <input id="password" type="password" autocomplete="current-password" />
          </div>
          <div>
            <button id="btnLogin">Login</button>
          </div>
          <div class="muted" id="loginMsg"></div>
        </div>
      </div>

      <div id="panel" class="hidden">
        <div class="card" style="margin-bottom:14px; display:flex; align-items:center; justify-content:space-between;">
          <div>Messages</div>
          <div class="actions">
            <button id="btnRefresh">Refresh</button>
            <button id="btnLogout" class="danger">Logout</button>
          </div>
        </div>
        <div class="card">
          <table id="tbl">
            <thead>
              <tr>
                <th style="width: 140px;">When</th>
                <th style="width: 160px;">From</th>
                <th>Subject / Message</th>
                <th style="width: 90px;">Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const apiBase = location.origin.replace(/\/$/, '');
      const qs = (s) => document.querySelector(s);
      const tbody = qs('#tbody');
      const loginBox = qs('#login');
      const panel = qs('#panel');
      const msg = qs('#loginMsg');
      const tokenKey = 'sw_admin_token';

      function setToken(t){ try { localStorage.setItem(tokenKey, t); } catch {} }
      function getToken(){ try { return localStorage.getItem(tokenKey) || ''; } catch { return ''; } }
      function clearToken(){ try { localStorage.removeItem(tokenKey); } catch {} }

      async function login(){
        msg.textContent = '';
        const username = qs('#username').value.trim();
        const password = qs('#password').value;
        if (!username || !password){ msg.textContent = 'Enter username and password'; return; }
        try {
          const res = await fetch(apiBase + '/api/admin/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
          const data = await res.json();
          if (!res.ok){ msg.textContent = data?.error || 'Login failed'; return; }
          setToken(data.token);
          loginBox.classList.add('hidden');
          panel.classList.remove('hidden');
          await refresh();
        } catch(e){ msg.textContent = 'Network error'; }
      }

      async function refresh(){
        tbody.innerHTML = '<tr><td colspan="4" class="muted">Loading…</td></tr>';
        try {
          const res = await fetch(apiBase + '/api/admin/messages', { headers: { 'Authorization': 'Bearer ' + getToken() } });
          if (res.status === 401){ clearToken(); location.reload(); return; }
          const list = await res.json();
          if (!Array.isArray(list)){ tbody.innerHTML = '<tr><td colspan="4" class="muted">No messages</td></tr>'; return; }
          if (list.length === 0){ tbody.innerHTML = '<tr><td colspan="4" class="muted">No messages</td></tr>'; return; }
          tbody.innerHTML = '';
          for (const m of list){
            const tr = document.createElement('tr');
            const when = new Date(m.ts || Date.now());
            tr.innerHTML = `
              <td>${when.toLocaleString()}</td>
              <td><div><strong>${m.name || '-'}</strong></div><div class="muted">${m.email || '-'}</div></td>
              <td><div><strong>${m.subject || '-'}</strong></div><div><pre>${(m.message||'').replace(/[<>]/g, '')}</pre></div></td>
              <td class="actions"><button data-id="${m.id}" class="danger btnDel">Delete</button></td>
            `;
            tbody.appendChild(tr);
          }
          tbody.querySelectorAll('.btnDel').forEach(btn => {
            btn.addEventListener('click', async (e)=>{
              const id = e.currentTarget.getAttribute('data-id');
              if (!id) return;
              if (!confirm('Delete this message?')) return;
              try {
                const res = await fetch(apiBase + '/api/admin/messages/' + encodeURIComponent(id), { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + getToken() } });
                if (res.status === 401){ clearToken(); location.reload(); return; }
                await refresh();
              } catch {}
            });
          });
        } catch(e){ tbody.innerHTML = '<tr><td colspan="4" class="muted">Failed to load</td></tr>'; }
      }

      qs('#btnLogin').addEventListener('click', login);
      qs('#btnRefresh').addEventListener('click', refresh);
      qs('#btnLogout').addEventListener('click', ()=>{ clearToken(); location.reload(); });

      // Auto-restore session
      if (getToken()){ loginBox.classList.add('hidden'); panel.classList.remove('hidden'); refresh(); }
    </script>
  </body>
  </html>


